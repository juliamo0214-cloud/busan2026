<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>釜山智慧助手 2026</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background: #fffafa; color: #4a3a3a; -webkit-tap-highlight-color: transparent; }
        .watercolor-bg { background: radial-gradient(circle at 10% 10%, #ffd1dc 0%, transparent 50%), radial-gradient(circle at 90% 90%, #fff0f5 0%, transparent 50%); background-attachment: fixed; }
        .app-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-radius: 28px; border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 10px 25px rgba(255, 182, 193, 0.15); }
        .day-active { background: #ff8fa3 !important; color: white !important; transform: scale(1.05); }
        .transit-link { border-left: 2px dashed #ffb2c1; margin-left: 1.8rem; padding: 0.8rem 0 0.8rem 1.2rem; }
        [v-cloak] { display: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .admin-glow { text-shadow: 0 0 10px rgba(255,143,163,0.5); }
    </style>
</head>
<body class="watercolor-bg min-h-screen pb-48">
    <div id="app" v-cloak class="max-w-md mx-auto px-5 pt-8">
        
        <header class="flex justify-between items-center mb-6">
            <div @touchstart="startPress" @touchend="endPress" @mousedown="startPress" @mouseup="endPress">
                <h1 class="text-2xl font-black text-[#ff8fa3]" :class="{'admin-glow': isAdmin}">{{ tabTitle }}</h1>
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Busan 2026 / {{ currentTimeDisplay }}</p>
            </div>
            <button v-if="isAdmin" @click="openMainModal" class="w-10 h-10 rounded-full bg-white shadow-md flex items-center justify-center text-[#ff8fa3] active:scale-90 transition">
                <i data-lucide="plus"></i>
            </button>
        </header>

        <nav v-if="activeTab === 'itinerary' || activeTab === 'budget'" class="flex gap-2 mb-4 overflow-x-auto pb-2 no-scrollbar">
            <button v-for="(day, idx) in itinerary" :key="idx" @click="selectedDayIdx = idx"
                    :class="['flex-shrink-0 w-16 h-20 rounded-2xl flex flex-col items-center justify-center bg-white text-gray-400 font-bold transition-all', { 'day-active': selectedDayIdx === idx }]">
                <span class="text-[9px] opacity-70">Day {{ idx + 1 }}</span>
                <span class="text-sm font-black">{{ day.date.substring(5) }}</span>
            </button>
        </nav>

        <main v-if="activeTab === 'itinerary'">
            <section class="app-card p-5 mb-6 border-none shadow-sm bg-white/40 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="text-orange-400"><i :data-lucide="getWeatherIcon(selectedDayIdx)"></i></div>
                    <div>
                        <h4 class="text-[10px] font-black text-gray-400 uppercase">釜山即時預報</h4>
                        <div class="flex items-baseline gap-2">
                            <span class="text-xl font-black text-gray-700">{{ weatherForecast[selectedDayIdx].temp }}</span>
                            <span class="text-[10px] font-bold text-gray-400">{{ weatherForecast[selectedDayIdx].cond }}</span>
                        </div>
                    </div>
                </div>
                <div class="text-right text-[10px] font-black text-pink-400">櫻花: {{ weatherForecast[selectedDayIdx].sakura }}</div>
            </section>

            <div v-for="(item, idx) in sortedUpcoming" :key="idx">
                <div class="app-card p-6 mb-2 relative overflow-hidden">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-black text-pink-400">{{ item.time }}</span>
                            <span v-if="item.tagName" :class="getTagClass(item.tagColor)" class="text-[8px] px-2 py-0.5 rounded text-white font-bold">{{ item.tagName }}</span>
                        </div>
                        <div v-if="isAdmin" class="flex gap-3">
                            <button @click="editItinerary(item.originalIdx)" class="text-blue-300"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                            <button @click="deleteItinerary(item.originalIdx)" class="text-red-200"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <h3 class="font-bold text-gray-800 flex items-center gap-1">
                        {{ item.location }}
                        <button @click="goMap(item.location)" class="text-[#03C75A]"><i data-lucide="map-pin" class="w-3 h-3"></i></button>
                    </h3>
                    <p class="text-xs text-gray-500 mt-2 whitespace-pre-line">{{ item.desc }}</p>
                </div>
                <div v-if="idx < sortedUpcoming.length - 1" class="transit-link">
                    <div class="flex items-center gap-2 text-[10px] font-bold text-gray-400">
                        <i :data-lucide="getTransitIcon(item.transitWay)" class="w-3 h-3 text-pink-300"></i>
                        <span>{{ item.transitWay }} {{ item.transitTime }}分</span>
                    </div>
                </div>
            </div>
        </main>

        <main v-if="activeTab === 'budget'">
            <div class="app-card p-6 mb-6 bg-gradient-to-br from-pink-400 to-pink-300 text-white shadow-lg">
                <div class="flex justify-between items-start">
                    <div><p class="text-[10px] font-black opacity-80 uppercase tracking-widest">本日支出 (KRW)</p><h2 class="text-3xl font-black">₩ {{ dayTotalKRW.toLocaleString() }}</h2></div>
                    <div class="text-right"><p class="text-[10px] font-black opacity-80 uppercase tracking-widest">台幣估算</p><h2 class="text-xl font-bold">NT$ {{ dayTotalTWD.toLocaleString() }}</h2></div>
                </div>
            </div>
            <div v-for="(exp, idx) in currentDayExpenses" :key="idx" class="app-card p-5 mb-3 flex justify-between items-center">
                <div><span class="text-sm font-black text-gray-800">₩ {{ exp.amount.toLocaleString() }}</span><p class="text-[10px] text-gray-400">{{ exp.category }} | {{ exp.desc }}</p></div>
                <button v-if="isAdmin" @click="deleteExpense(idx)" class="text-red-200"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
            </div>
        </main>

        <main v-if="activeTab === 'info'" class="space-y-4">
            <div v-for="(info, idx) in travelInfo" :key="idx" class="app-card p-6 border-l-8" :style="{ borderColor: ['#ffb6c1','#add8e6','#98fb98','#ffdab9','#e6e6fa'][idx % 5] }">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-black text-gray-700">{{ info.title }}</h3>
                    <button v-if="isAdmin" @click="editInfo(idx)" class="text-blue-300"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                </div>
                <div class="text-sm text-gray-600 whitespace-pre-wrap">{{ info.content }}</div>
            </div>
        </main>

        <nav class="fixed bottom-6 left-8 right-8 h-20 bg-white/90 backdrop-blur-xl rounded-full flex justify-around items-center px-4 shadow-2xl z-[90]">
            <button v-for="t in [['itinerary','calendar','行程'],['budget','banknote','記帳'],['info','info','資訊']]" :key="t[0]" @click="activeTab = t[0]" :class="{'text-[#ff8fa3]': activeTab === t[0]}" class="flex flex-col items-center text-gray-300">
                <i :data-lucide="t[1]"></i><span class="text-[9px] font-bold mt-1 uppercase">{{t[2]}}</span>
            </button>
        </nav>

        <div v-if="showModal" class="fixed inset-0 z-[100] flex items-end justify-center">
            <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" @click="showModal = false"></div>
            <div class="bg-white w-full rounded-t-[40px] p-8 pb-12 z-10 max-h-[90vh] overflow-y-auto">
                <h2 class="text-center font-black text-gray-700 mb-6">{{ modalTitle }}</h2>
                
                <div v-if="modalMode === 'itinerary'" class="space-y-4">
                    <div class="grid grid-cols-2 gap-2">
                        <select v-model="itineraryForm.day" class="p-4 bg-gray-50 rounded-2xl text-sm font-bold"><option v-for="(d,i) in itinerary" :value="i">Day {{i+1}}</option></select>
                        <input v-model="itineraryForm.time" type="time" class="p-4 bg-gray-50 rounded-2xl text-sm">
                    </div>
                    <input v-model="itineraryForm.location" placeholder="地點" class="w-full p-4 bg-gray-50 rounded-2xl text-sm">
                    <textarea v-model="itineraryForm.desc" placeholder="詳細備註" class="w-full p-4 bg-gray-50 rounded-2xl text-sm h-24"></textarea>
                    <button @click="saveItinerary" class="w-full py-4 bg-[#ff8fa3] text-white rounded-2xl font-black">儲存並同步雲端</button>
                </div>

                <div v-if="modalMode === 'budget'" class="space-y-4">
                    <input v-model.number="expenseForm.amount" type="number" placeholder="₩ 韓元金額" class="w-full p-4 bg-gray-50 rounded-2xl font-black">
                    <input v-model="expenseForm.desc" placeholder="項目" class="w-full p-4 bg-gray-50 rounded-2xl text-sm">
                    <button @click="saveExpense" class="w-full py-4 bg-[#ff8fa3] text-white rounded-2xl font-black">新增花費</button>
                </div>

                <div v-if="modalMode === 'info'" class="space-y-4">
                    <input v-model="infoForm.title" placeholder="標題" class="w-full p-4 bg-gray-50 rounded-2xl font-black">
                    <textarea v-model="infoForm.content" class="w-full p-4 bg-gray-50 rounded-2xl h-64 text-sm"></textarea>
                    <button @click="saveInfo" class="w-full py-4 bg-[#ff8fa3] text-white rounded-2xl font-black">儲存</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 1. Firebase 配置 (你提供的最新版本)
        const firebaseConfig = {
            apiKey: "AIzaSyADwtA9c31UQaTpns-AyIw68MH-MM0W134",
            authDomain: "busan2026-7887a.firebaseapp.com",
            databaseURL: "https://busan2026-7887a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "busan2026-7887a",
            storageBucket: "busan2026-7887a.firebasestorage.app",
            messagingSenderId: "741260336593",
            appId: "1:741260336593:web:db9af7bd02403ca8cad4f0"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        // 管理員密碼與 UID (你可以填入你手機領到的 UID)
        const MASTER_UID = "WAITING_FOR_UID"; 

        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                const userUid = ref(null);
                const isAdmin = ref(localStorage.getItem('busan_admin') === 'true');
                const pressTimer = ref(null);
                
                const activeTab = ref('itinerary');
                const selectedDayIdx = ref(0);
                const showModal = ref(false);
                const modalMode = ref('itinerary');
                const editingIdx = ref(null);
                const now = ref(new Date());

                // 資料結構
                const itinerary = ref([
                    { date: '2026/03/31', items: [], expenses: [] },
                    { date: '2026/04/01', items: [], expenses: [] },
                    { date: '2026/04/02', items: [], expenses: [] },
                    { date: '2026/04/03', items: [], expenses: [] },
                    { date: '2026/04/04', items: [], expenses: [] }
                ]);
                const travelInfo = ref([{ title: '航班', content: '載入中...' }]);
                const weatherForecast = ref(Array(5).fill({ temp: '15°C', cond: '晴', sakura: '盛開' }));

                const itineraryForm = ref({ day: 0, time: '12:00', location: '', desc: '', tagName: '', tagColor: 'pink', transitWay: '步行', transitTime: 10 });
                const expenseForm = ref({ amount: 0, desc: '', category: '一般' });
                const infoForm = ref({ title: '', content: '', idx: null });

                // 同步至 Firebase
                const sync = () => {
                    if(isAdmin.value) {
                        db.ref('busanData').set({
                            itinerary: JSON.parse(JSON.stringify(itinerary.value)),
                            travelInfo: JSON.parse(JSON.stringify(travelInfo.value))
                        });
                    }
                };

                // 管理員解鎖 (長按左上角標題 3 秒)
                const startPress = () => { 
                    pressTimer.value = setTimeout(() => {
                        const pw = prompt("管理密碼：");
                        if(pw === '2026') { 
                            isAdmin.value = true; 
                            localStorage.setItem('busan_admin', 'true'); 
                            alert("管理員模式已開啟！");
                        }
                    }, 3000);
                };
                const endPress = () => clearTimeout(pressTimer.value);

                onMounted(() => {
                    // 1. 匿名登入
                    auth.signInAnonymously();
                    auth.onAuthStateChanged(user => { if(user) userUid.value = user.uid; });

                    // 2. 監聽雲端資料
                    db.ref('busanData').on('value', snap => {
                        const d = snap.val();
                        if(d) {
                            itinerary.value = d.itinerary;
                            travelInfo.value = d.travelInfo;
                        }
                        setTimeout(() => lucide.createIcons(), 100);
                    });

                    setInterval(() => now.value = new Date(), 60000);
                });

                return {
                    isAdmin, startPress, endPress, activeTab, selectedDayIdx, itinerary, travelInfo, weatherForecast, showModal, modalMode, itineraryForm, expenseForm, infoForm,
                    tabTitle: computed(() => ({ itinerary: '釜山行程', budget: '旅費記帳', info: '旅遊資訊' }[activeTab.value])),
                    modalTitle: computed(() => ({ itinerary: '編輯行程', budget: '新增帳務', info: '編輯資訊' }[modalMode.value])),
                    currentTimeDisplay: computed(() => now.value.toLocaleTimeString('zh-TW', {hour12:false, hour:'2-digit', minute:'2-digit'})),
                    sortedUpcoming: computed(() => (itinerary.value[selectedDayIdx.value].items || []).map((i,idx) => ({...i, originalIdx: idx}))),
                    currentDayExpenses: computed(() => itinerary.value[selectedDayIdx.value].expenses || []),
                    dayTotalKRW: computed(() => (itinerary.value[selectedDayIdx.value].expenses || []).reduce((s, e) => s + (e.amount || 0), 0)),
                    dayTotalTWD: computed(() => Math.round((itinerary.value[selectedDayIdx.value].expenses || []).reduce((s, e) => s + (e.amount || 0), 0) * 0.0242)),
                    
                    openMainModal: () => { modalMode.value = activeTab.value; editingIdx.value = null; showModal.value = true; },
                    saveItinerary: () => {
                        if(editingIdx.value !== null) itinerary.value[selectedDayIdx.value].items.splice(editingIdx.value, 1);
                        itinerary.value[itineraryForm.value.day].items.push({...itineraryForm.value});
                        itinerary.value[itineraryForm.value.day].items.sort((a,b)=>a.time.localeCompare(b.time));
                        sync(); showModal.value = false;
                    },
                    deleteItinerary: (idx) => { itinerary.value[selectedDayIdx.value].items.splice(idx,1); sync(); },
                    saveExpense: () => {
                        if(!itinerary.value[selectedDayIdx.value].expenses) itinerary.value[selectedDayIdx.value].expenses = [];
                        itinerary.value[selectedDayIdx.value].expenses.push({...expenseForm.value});
                        sync(); showModal.value = false;
                    },
                    deleteExpense: (idx) => { itinerary.value[selectedDayIdx.value].expenses.splice(idx,1); sync(); },
                    editInfo: (idx) => { modalMode.value='info'; infoForm.value={...travelInfo.value[idx], idx}; showModal.value=true; },
                    saveInfo: () => { travelInfo.value[infoForm.value.idx] = {...infoForm.value}; sync(); showModal.value=false; },
                    editItinerary: (idx) => { modalMode.value='itinerary'; editingIdx.value=idx; itineraryForm.value={...itinerary.value[selectedDayIdx.value].items[idx], day:selectedDayIdx.value}; showModal.value=true; },
                    
                    goMap: (loc) => window.open(`https://map.naver.com/v5/search/${encodeURIComponent(loc)}`),
                    getWeatherIcon: (idx) => weatherForecast.value[idx].cond.includes('雨') ? 'cloud-rain' : 'sun',
                    getTransitIcon: (way) => ({ '步行': 'person-standing', '計程車': 'car', '巴士': 'bus', '地鐵': 'train' }[way] || 'move'),
                    getTagClass: (c) => ({ 'pink': 'bg-pink-400', 'blue': 'bg-blue-400', 'yellow': 'bg-yellow-500' }[c] || 'bg-gray-400')
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
