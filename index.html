<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>釜山智慧助手 2026</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background: #fffafa; color: #4a3a3a; -webkit-tap-highlight-color: transparent; }
        .watercolor-bg { background: radial-gradient(circle at 10% 10%, #ffd1dc 0%, transparent 50%), radial-gradient(circle at 90% 90%, #fff0f5 0%, transparent 50%); background-attachment: fixed; }
        .app-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-radius: 28px; border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 10px 25px rgba(255, 182, 193, 0.15); }
        .day-active { background: #ff8fa3 !important; color: white !important; transform: scale(1.05); }
        .transit-link { border-left: 2px dashed #ffb2c1; margin-left: 1.8rem; padding: 0.8rem 0 0.8rem 1.2rem; }
        [v-cloak] { display: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .info-card-1 { background: #fff0f5; border-left: 8px solid #ffb6c1; }
        .info-card-2 { background: #f0f8ff; border-left: 8px solid #add8e6; }
        .info-card-3 { background: #f5fffa; border-left: 8px solid #98fb98; }
        .info-card-4 { background: #fffaf0; border-left: 8px solid #ffdab9; }
        .info-card-5 { background: #f8f8ff; border-left: 8px solid #e6e6fa; }
    </style>
</head>
<body class="watercolor-bg min-h-screen pb-48">
    <div id="app" v-cloak class="max-w-md mx-auto px-5 pt-8">
        
        <header class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl font-black text-[#ff8fa3]">{{ tabTitle }}</h1>
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Busan 2026 / {{ currentTimeDisplay }}</p>
                <p v-if="!isAdmin" class="text-[8px] text-gray-300">ID: {{ userUid }}</p>
                <p v-else class="text-[8px] text-pink-400 font-bold">● 管理員模式已啟動</p>
            </div>
            <button v-if="isAdmin" @click="openMainModal" class="w-10 h-10 rounded-full bg-white shadow-md flex items-center justify-center text-[#ff8fa3] active:scale-90 transition">
                <i data-lucide="plus"></i>
            </button>
        </header>

        <nav v-if="activeTab !== 'info'" class="flex gap-2 mb-4 overflow-x-auto pb-2 no-scrollbar">
            <button v-for="(day, idx) in itinerary" :key="idx" @click="selectedDayIdx = idx"
                    :class="['flex-shrink-0 w-16 h-20 rounded-2xl flex flex-col items-center justify-center bg-white text-gray-400 font-bold transition-all', { 'day-active': selectedDayIdx === idx }]">
                <span class="text-[9px] opacity-70">Day {{ idx + 1 }}</span>
                <span class="text-sm font-black">{{ day.date.substring(5) }}</span>
            </button>
        </nav>

        <main v-if="activeTab === 'itinerary'">
            <section class="app-card p-5 mb-6 border-none shadow-sm bg-white/40 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="text-orange-400"><i :data-lucide="getWeatherIcon(selectedDayIdx)"></i></div>
                    <div>
                        <h4 class="text-[10px] font-black text-gray-400 uppercase">釜山即時預報</h4>
                        <div class="flex items-baseline gap-2">
                            <span class="text-xl font-black text-gray-700">{{ weatherForecast[selectedDayIdx].temp }}</span>
                            <span class="text-[10px] font-bold text-gray-400">{{ weatherForecast[selectedDayIdx].cond }}</span>
                        </div>
                    </div>
                </div>
                <div class="text-right text-[10px] font-black text-pink-400">櫻花: {{ weatherForecast[selectedDayIdx].sakura }}</div>
            </section>

            <div v-for="(item, idx) in sortedUpcoming" :key="idx">
                <div class="app-card p-6 mb-2 relative overflow-hidden">
                    <div class="absolute top-0 right-0 px-3 py-1 bg-pink-50 text-[9px] font-black text-pink-400 rounded-bl-xl">
                        {{ item.type }}
                    </div>
                    
                    <div class="flex justify-between items-start mb-2 mt-1">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-black text-pink-400">{{ item.time }}</span>
                            <span v-if="item.tagName" :class="getTagClass(item.tagColor)" class="text-[8px] px-2 py-0.5 rounded text-white font-bold">{{ item.tagName }}</span>
                        </div>
                        <div v-if="isAdmin" class="flex gap-3">
                            <button @click="editItinerary(item.originalIdx)" class="text-blue-300"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                            <button @click="deleteItinerary(item.originalIdx)" class="text-red-200"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <h3 class="font-bold text-gray-800 flex items-center gap-1">
                        {{ item.location }}
                        <button @click="goMap('naver', item.location)" class="text-[#03C75A]"><i data-lucide="map-pin" class="w-3 h-3"></i></button>
                    </h3>
                    <p class="text-xs text-gray-500 mt-2 whitespace-pre-line">{{ item.desc }}</p>
                </div>

                <div v-if="idx < sortedUpcoming.length - 1" class="transit-link">
                    <div class="flex items-center gap-2 text-[10px] font-bold text-gray-400">
                        <i :data-lucide="getTransitIcon(item.transitWay)" class="w-3 h-3 text-pink-300"></i>
                        <span>{{ item.transitWay }} {{ item.transitTime }}分</span>
                    </div>
                </div>
            </div>
        </main>

        <main v-if="activeTab === 'budget'">
            <div class="app-card p-6 mb-6 bg-gradient-to-br from-pink-400 to-pink-300 text-white shadow-lg">
                <div class="flex justify-between items-start">
                    <div><p class="text-[10px] font-black opacity-80 uppercase tracking-widest">本日總支出</p><h2 class="text-3xl font-black">₩ {{ dayTotalKRW.toLocaleString() }}</h2></div>
                    <div class="text-right"><p class="text-[10px] font-black opacity-80 uppercase tracking-widest">台幣約</p><h2 class="text-xl font-bold">NT$ {{ dayTotalTWD.toLocaleString() }}</h2></div>
                </div>
            </div>
            <div class="space-y-3">
                <div v-for="(exp, idx) in currentDayExpenses" :key="idx" class="app-card p-5 flex justify-between items-center">
                    <div class="flex-grow">
                        <div class="flex items-center gap-2"><span class="text-sm font-black text-gray-800">₩ {{ exp.amount.toLocaleString() }}</span></div>
                        <p class="text-[10px] text-gray-400 mt-1">{{ exp.category }} | {{ exp.desc }}</p>
                    </div>
                    <div v-if="isAdmin" class="flex gap-4">
                        <button @click="deleteExpense(idx)" class="text-red-200"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>
            </div>
        </main>

        <main v-if="activeTab === 'info'" class="space-y-4">
            <div v-for="(info, idx) in travelInfo" :key="idx" :class="['app-card p-6 relative overflow-hidden', 'info-card-' + ((idx % 5) + 1)]">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-black text-gray-700 flex items-center gap-2">{{ info.title }}</h3>
                    <div v-if="isAdmin" class="flex gap-3">
                        <button @click="editInfo(idx)" class="text-blue-400"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                    </div>
                </div>
                <div class="text-sm text-gray-600 whitespace-pre-wrap">{{ info.content }}</div>
            </div>
        </main>

        <div v-if="showModal" class="fixed inset-0 z-[100] flex items-end justify-center">
            <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" @click="showModal = false"></div>
            <div class="bg-white w-full rounded-t-[40px] p-8 pb-12 z-10 max-h-[95vh] overflow-y-auto">
                <h2 class="text-center font-black text-gray-700 mb-6 text-lg">{{ modalTitle }}</h2>
                
                <div v-if="modalMode === 'itinerary'" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <select v-model="itineraryForm.day" class="p-4 bg-gray-50 rounded-2xl text-sm font-bold"><option v-for="(d,i) in itinerary" :value="i">Day {{i+1}}</option></select>
                        <input v-model="itineraryForm.time" type="time" class="p-4 bg-gray-50 rounded-2xl text-sm font-bold">
                    </div>
                    <input v-model="itineraryForm.location" placeholder="地點名稱" class="w-full p-4 bg-gray-50 rounded-2xl text-sm font-bold">
                    <textarea v-model="itineraryForm.desc" placeholder="備註..." class="w-full p-4 bg-gray-50 rounded-2xl text-sm h-24"></textarea>
                    <div class="grid grid-cols-2 gap-4">
                        <select v-model="itineraryForm.transitWay" class="p-4 bg-gray-50 rounded-2xl text-sm font-bold">
                            <option v-for="w in ['步行','地鐵','巴士','計程車']" :value="w">{{w}}</option>
                        </select>
                        <input v-model.number="itineraryForm.transitTime" type="number" placeholder="分鐘" class="p-4 bg-gray-50 rounded-2xl text-sm font-bold">
                    </div>
                    <button @click="saveItinerary" class="w-full py-4 bg-[#ff8fa3] text-white rounded-2xl font-black shadow-lg shadow-pink-100">儲存資料</button>
                </div>

                <div v-if="modalMode === 'budget'" class="space-y-4">
                    <input v-model.number="expenseForm.amount" type="number" class="w-full p-4 bg-gray-50 rounded-2xl text-lg font-black" placeholder="₩ 韓元金額">
                    <input v-model="expenseForm.desc" placeholder="項目內容" class="w-full p-4 bg-gray-50 rounded-2xl text-sm">
                    <button @click="saveExpense" class="w-full py-4 bg-[#ff8fa3] text-white rounded-2xl font-black">存入帳務</button>
                </div>

                <div v-if="modalMode === 'info'" class="space-y-4">
                    <input v-model="infoForm.title" placeholder="標題" class="w-full p-4 bg-gray-50 rounded-2xl text-sm font-black">
                    <textarea v-model="infoForm.content" placeholder="內容..." class="w-full p-4 bg-gray-50 rounded-2xl text-sm h-64"></textarea>
                    <button @click="saveInfo" class="w-full py-4 bg-[#ff8fa3] text-white rounded-2xl font-black">更新資訊</button>
                </div>
            </div>
        </div>

        <nav class="fixed bottom-6 left-8 right-8 h-20 bg-white/90 backdrop-blur-xl rounded-full flex justify-around items-center px-4 shadow-2xl z-[90]">
            <button v-for="t in [['itinerary','calendar','行程'],['budget','banknote','記帳'],['info','info','資訊']]" :key="t[0]" @click="activeTab = t[0]" :class="{'text-[#ff8fa3]': activeTab === t[0]}" class="flex flex-col items-center text-gray-300">
                <i :data-lucide="t[1]"></i><span class="text-[9px] font-bold mt-1 uppercase">{{t[2]}}</span>
            </button>
        </nav>
    </div>

    <script>
        // 1. Firebase 設定 (恢復原本設定)
        const firebaseConfig = {
            apiKey: "AIzaSyADwtA9c31UQaTpns-AyIw68MH-MM0W134",
            authDomain: "busan2026-7887a.firebaseapp.com",
            databaseURL: "https://busan2026-7887a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "busan2026-7887a",
            storageBucket: "busan2026-7887a.firebasestorage.app",
            messagingSenderId: "741260336593",
            appId: "1:741260336593:web:db9af7bd02403ca8cad4f0"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        auth.signInAnonymously();

        // 2. 管理員 UID (手機打開後看到 ID，再填回這裡)
        const MASTER_UID = "WAITING_FOR_UID"; 

        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                const userUid = ref(null);
                const isAdmin = computed(() => userUid.value === MASTER_UID || userUid.value === "你目前手機顯示的UID"); 
                
                const activeTab = ref('itinerary');
                const selectedDayIdx = ref(0);
                const showModal = ref(false);
                const modalMode = ref('itinerary');
                const editingIdx = ref(null);
                const now = ref(new Date());
                const exchangeRate = ref(0.0242);

                // 預設資料結構
                const itinerary = ref([{ date: '2026/03/31', items: [], expenses: [] }, { date: '2026/04/01', items: [], expenses: [] }, { date: '2026/04/02', items: [], expenses: [] }, { date: '2026/04/03', items: [], expenses: [] }, { date: '2026/04/04', items: [], expenses: [] }]);
                const travelInfo = ref([{ title: '航班資訊', content: '' }, { title: '住宿資訊', content: '' }, { title: '緊急聯絡', content: '' }, { title: '物品清單', content: '' }, { title: '其他提醒', content: '' }]);
                const weatherForecast = ref([{ temp: '14°C', cond: '晴', sakura: '開始' }, { temp: '15°C', cond: '晴', sakura: '盛開' }, { temp: '13°C', cond: '雲', sakura: '盛開' }, { temp: '16°C', cond: '晴', sakura: '滿開' }, { temp: '14°C', cond: '雨', sakura: '吹雪' }]);

                const itineraryForm = ref({ day: 0, time: '12:00', type: '景點', location: '', desc: '', tagName: '', tagColor: 'pink', transitWay: '步行', transitTime: 10 });
                const expenseForm = ref({ amount: 0, category: '飲食', desc: '' });
                const infoForm = ref({ title: '', content: '', idx: null });

                // 同步至 Firebase
                const sync = () => { 
                    if(isAdmin.value) {
                        db.ref('busanData').set({ 
                            itinerary: JSON.parse(JSON.stringify(itinerary.value)), 
                            travelInfo: JSON.parse(JSON.stringify(travelInfo.value)) 
                        }); 
                    }
                };

                onMounted(() => {
                    // 領取通行證
                    auth.onAuthStateChanged(user => { if(user) userUid.value = user.uid; });

                    // 監聽雲端即時更新
                    db.ref('busanData').on('value', snap => {
                        const d = snap.val();
                        if(d) { 
                            itinerary.value = d.itinerary || itinerary.value; 
                            travelInfo.value = d.travelInfo || travelInfo.value; 
                        }
                        setTimeout(() => lucide.createIcons(), 150);
                    });
                    
                    setInterval(() => now.value = new Date(), 60000);
                });

                // 只有管理員變動資料時才觸發監控同步
                watch([itinerary, travelInfo], () => { if(isAdmin.value) sync(); }, { deep: true });

                return {
                    userUid, isAdmin, activeTab, selectedDayIdx, itinerary, travelInfo, weatherForecast, showModal, modalMode, itineraryForm, expenseForm, infoForm,
                    tabTitle: computed(() => ({ itinerary: '釜山智慧助手', budget: '旅費記帳', info: '旅遊資訊' }[activeTab.value])),
                    modalTitle: computed(() => ({ itinerary: '編輯行程', budget: '新增帳務', info: '編輯資訊' }[modalMode.value])),
                    currentTimeDisplay: computed(() => now.value.toLocaleTimeString('zh-TW', {hour12:false, hour:'2-digit', minute:'2-digit'})),
                    sortedUpcoming: computed(() => (itinerary.value[selectedDayIdx.value].items || []).map((i,idx) => ({...i, originalIdx: idx}))),
                    currentDayExpenses: computed(() => itinerary.value[selectedDayIdx.value].expenses || []),
                    dayTotalKRW: computed(() => (itinerary.value[selectedDayIdx.value].expenses || []).reduce((s, e) => s + (e.amount || 0), 0)),
                    dayTotalTWD: computed(() => Math.round((itinerary.value[selectedDayIdx.value].expenses || []).reduce((s, e) => s + (e.amount || 0), 0) * exchangeRate.value)),
                    
                    openMainModal: () => { modalMode.value = activeTab.value; editingIdx.value = null; showModal.value = true; },
                    saveItinerary: () => { 
                        if(editingIdx.value !== null) itinerary.value[selectedDayIdx.value].items.splice(editingIdx.value, 1);
                        const targetDay = itineraryForm.value.day;
                        if(!itinerary.value[targetDay].items) itinerary.value[targetDay].items = [];
                        itinerary.value[targetDay].items.push({...itineraryForm.value});
                        itinerary.value[targetDay].items.sort((a,b)=>a.time.localeCompare(b.time));
                        showModal.value = false;
                    },
                    deleteItinerary: (idx) => { itinerary.value[selectedDayIdx.value].items.splice(idx,1); },
                    saveExpense: () => { 
                        if(!itinerary.value[selectedDayIdx.value].expenses) itinerary.value[selectedDayIdx.value].expenses = [];
                        itinerary.value[selectedDayIdx.value].expenses.push({...expenseForm.value});
                        showModal.value = false;
                    },
                    deleteExpense: (idx) => { itinerary.value[selectedDayIdx.value].expenses.splice(idx,1); },
                    editInfo: (idx) => { modalMode.value='info'; infoForm.value={...travelInfo.value[idx], idx}; showModal.value=true; },
                    saveInfo: () => { travelInfo.value[infoForm.value.idx] = {...infoForm.value}; showModal.value=false; },
                    editItinerary: (idx) => { modalMode.value='itinerary'; editingIdx.value=idx; itineraryForm.value={...itinerary.value[selectedDayIdx.value].items[idx], day:selectedDayIdx.value}; showModal.value=true; },
                    
                    goMap: (type, loc) => window.open(`https://map.naver.com/v5/search/${encodeURIComponent(loc)}`),
                    getWeatherIcon: (idx) => weatherForecast.value[idx].cond.includes('雨') ? 'cloud-rain' : (weatherForecast.value[idx].cond.includes('雲') ? 'cloud' : 'sun'),
                    getTransitIcon: (way) => ({ '步行': 'person-standing', '計程車': 'car', '巴士': 'bus', '地鐵': 'train' }[way] || 'move'),
                    getTagClass: (c) => ({ 'pink': 'bg-pink-400', 'blue': 'bg-blue-400', 'yellow': 'bg-yellow-500' }[c] || 'bg-gray-400')
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
