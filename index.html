<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>釜山智慧助手 2026</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background: #fffafa; color: #4a3a3a; -webkit-tap-highlight-color: transparent; }
        
        /* 1. 視覺語彙 */
        .watercolor-bg { 
            background: radial-gradient(circle at 10% 10%, #ffeaf0 0%, transparent 50%), 
                        radial-gradient(circle at 90% 90%, #f0ebff 0%, transparent 50%), #fffafa; 
            background-attachment: fixed; 
        }
        
        .app-card { 
            background: rgba(255, 255, 255, 0.85); 
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-radius: 28px; border: 1px solid rgba(255, 255, 255, 0.6); 
            box-shadow: 0 10px 25px rgba(255, 143, 163, 0.1); 
        }

        /* 五色資訊卡邊框與浮水標 */
        .info-card { position: relative; overflow: hidden; }
        .info-card::after { 
            content: attr(data-title); position: absolute; bottom: -5px; right: 10px; 
            font-size: 2.5rem; font-weight: 900; font-style: italic; 
            color: rgba(0,0,0,0.03); z-index: 0; pointer-events: none; 
        }
        .info-card-1 { border-left: 8px solid #ffb6c1; }
        .info-card-2 { border-left: 8px solid #add8e6; }
        .info-card-3 { border-left: 8px solid #caffbf; }
        .info-card-4 { border-left: 8px solid #ffd6a5; }
        .info-card-5 { border-left: 8px solid #bdb2ff; }

        /* 動態與行程狀態 */
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .animate-pulse-soft { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .past-item { opacity: 0.45; filter: grayscale(0.8); order: 99; transform: scale(0.96); }
        .transit-link { border-left: 2px dashed #ffb6c1; margin-left: 1.8rem; height: 32px; position: relative; }
        
        .day-active { background: #ff8fa3 !important; color: white !important; box-shadow: 0 8px 15px rgba(255, 143, 163, 0.3); }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="watercolor-bg min-h-screen pb-40">
    <div id="app" v-cloak class="max-w-md mx-auto px-5 pt-8">
        
        <header class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl font-black text-[#ff8fa3] tracking-tighter">釜山智慧助手 2026</h1>
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">{{ currentTime }} / BUSAN_V20</p>
            </div>
            <button @click="openModal('add')" class="w-12 h-12 bg-white rounded-full shadow-lg flex items-center justify-center text-[#ff8fa3] active:scale-90 transition">
                <i data-lucide="plus"></i>
            </button>
        </header>

        <nav v-if="activeTab === 'itinerary'" class="flex gap-3 mb-6 overflow-x-auto no-scrollbar py-2">
            <button v-for="(day, idx) in itinerary" :key="idx" @click="selectedDayIdx = idx"
                :class="['flex-shrink-0 px-6 py-3 rounded-2xl font-black transition-all', selectedDayIdx === idx ? 'day-active' : 'bg-white text-gray-400']">
                Day {{ idx + 1 }}
            </button>
        </nav>

        <section v-if="activeTab === 'itinerary'" class="app-card p-5 mb-6 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div :class="{'animate-pulse-soft': weatherLoading}" class="text-orange-400">
                    <i :data-lucide="weather.icon" class="w-8 h-8"></i>
                </div>
                <div>
                    <h4 class="text-[10px] font-black text-gray-400 uppercase">Busan Today</h4>
                    <p class="text-lg font-black text-gray-700">{{ weather.temp }} <span class="text-xs text-gray-400">{{ weather.desc }}</span></p>
                </div>
            </div>
            <div class="text-right">
                <p class="text-[10px] font-black text-pink-300 uppercase">Rate (KRW/TWD)</p>
                <p class="text-sm font-bold text-gray-500">{{ exchangeRate }}</p>
            </div>
        </section>

        <main v-if="activeTab === 'itinerary'" class="flex flex-col">
            <div v-for="(item, idx) in sortedItems" :key="idx" :class="['flex flex-col', {'past-item': item.isPast}]">
                <div class="app-card p-6 relative">
                    <div class="flex justify-between items-start mb-3">
                        <span class="text-xs font-black text-pink-400">{{ item.time }}</span>
                        <div class="flex gap-2">
                            <span :style="{ backgroundColor: item.tagColor }" class="text-[9px] text-white px-2 py-0.5 rounded-full font-bold">{{ item.category }}</span>
                            <span v-if="item.tagText" class="text-[9px] bg-gray-100 text-gray-400 px-2 py-0.5 rounded-full font-bold">{{ item.tagText }}</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-bold text-gray-800">{{ item.location }}</h3>
                        <div class="flex gap-3">
                            <button @click="openNaver(item.location)" class="text-[#03C75A]"><i data-lucide="map-pin" class="w-5 h-5"></i></button>
                            <button @click="editItem(item)" class="text-gray-300"><i data-lucide="more-vertical" class="w-5 h-5"></i></button>
                        </div>
                    </div>
                    <p v-if="item.desc" class="text-xs text-gray-500 mt-2 leading-relaxed">{{ item.desc }}</p>
                    <div v-if="item.isPast" class="absolute top-2 right-4 text-[8px] font-black text-gray-300 uppercase tracking-widest">Completed</div>
                </div>

                <div v-if="idx < sortedItems.length - 1" class="transit-link">
                    <div class="absolute left-4 top-1/2 -translate-y-1/2 flex items-center gap-2 whitespace-nowrap">
                        <i :data-lucide="getTransitIcon(item.transitWay)" class="w-3 h-3 text-pink-300"></i>
                        <span class="text-[9px] font-bold text-gray-300 uppercase">{{ item.transitWay }} {{ item.transitTime }} MIN</span>
                    </div>
                </div>
            </div>
        </main>

        <main v-if="activeTab === 'info'" class="space-y-4">
            <div v-for="(info, idx) in travelInfo" :key="idx" 
                :class="['app-card p-6 info-card', 'info-card-' + ((idx % 5) + 1)]"
                :data-title="info.title">
                <div class="flex justify-between items-center mb-4 relative z-10">
                    <h3 class="font-black text-gray-700 flex items-center gap-2">
                        <i :data-lucide="info.icon || 'file-text'" class="w-4 h-4 text-[#ff8fa3]"></i>
                        {{ info.title }}
                    </h3>
                    <button @click="editInfo(idx)" class="text-gray-300"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                </div>
                <div class="text-sm text-gray-600 whitespace-pre-wrap leading-relaxed relative z-10">{{ info.content }}</div>
            </div>
        </main>

        <nav class="fixed bottom-8 left-8 right-8 h-20 bg-white/70 backdrop-blur-2xl rounded-[35px] flex justify-around items-center px-6 shadow-2xl z-[90] border border-white/50">
            <button @click="activeTab = 'itinerary'" :class="{'text-[#ff8fa3] scale-110': activeTab === 'itinerary'}" class="flex flex-col items-center text-gray-300 transition-all">
                <i data-lucide="calendar-days"></i>
                <span class="text-[8px] font-black mt-1">ITINERARY</span>
            </button>
            <button @click="activeTab = 'info'" :class="{'text-[#ff8fa3] scale-110': activeTab === 'info'}" class="flex flex-col items-center text-gray-300 transition-all">
                <i data-lucide="sticky-note"></i>
                <span class="text-[8px] font-black mt-1">MEMO</span>
            </button>
        </nav>

        <div v-if="showModal" class="fixed inset-0 z-[100] flex items-end">
            <div class="absolute inset-0 bg-black/20 backdrop-blur-sm" @click="showModal = false"></div>
            <div class="w-full bg-white rounded-t-[40px] p-8 pb-12 animate-slide-up relative z-10 shadow-2xl">
                <div class="w-12 h-1.5 bg-gray-100 rounded-full mx-auto mb-6"></div>
                <h2 class="text-xl font-black text-center mb-6 text-gray-700">編輯行程行程</h2>
                <div class="space-y-4">
                    <input v-model="form.location" placeholder="地點名稱" class="w-full p-4 bg-gray-50 rounded-2xl border-none font-bold">
                    <div class="flex gap-3">
                        <input type="time" v-model="form.time" class="flex-grow p-4 bg-gray-50 rounded-2xl border-none font-bold">
                        <select v-model="form.category" class="p-4 bg-gray-50 rounded-2xl border-none font-bold">
                            <option v-for="c in categories" :key="c">{{c}}</option>
                        </select>
                    </div>
                    <textarea v-model="form.desc" placeholder="行程備註..." class="w-full p-4 bg-gray-50 rounded-2xl border-none h-24 text-sm"></textarea>
                    <button @click="saveItem" class="w-full py-5 bg-[#ff8fa3] text-white rounded-2xl font-black shadow-lg shadow-pink-100 active:scale-95 transition">儲存行程</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                const activeTab = ref('itinerary');
                const selectedDayIdx = ref(0);
                const showModal = ref(false);
                const weatherLoading = ref(true);
                const exchangeRate = ref('---');
                const currentTime = ref('');
                const categories = ['景點','交通','購物','餐飲','住宿','其他'];

                // 5. 資料存取邏輯
                const itinerary = ref(JSON.parse(localStorage.getItem('busan_v20_itinerary')) || [
                    { items: [{ time: '12:00', location: '抵達金海機場', category: '交通', tagText: '首站', tagColor: '#ff8fa3', transitWay: '地鐵', transitTime: '40', desc: '辦理入境' }] },
                    { items: [] }, { items: [] }, { items: [] }, { items: [] }
                ]);

                const travelInfo = ref(JSON.parse(localStorage.getItem('busan_v20_info')) || [
                    { title: '航班資訊', icon: 'plane', content: 'BR170 TPE > PUS\nBR171 PUS > TPE' },
                    { title: '住宿地點', icon: 'home', content: '海雲台大飯店\n地址：釜山廣域市...' },
                    { title: '緊急聯絡', icon: 'phone', content: '韓國觀光公社：1330\n緊急救護：119' },
                    { title: '購物清單', icon: 'shopping-bag', content: '□ 燒酒杯\n□ 魚板\n□ 橄欖油海苔' }
                ]);

                const weather = ref({ temp: '--°', desc: '載入中', icon: 'sun' });
                const form = ref({ location: '', time: '12:00', category: '景點', desc: '', tagColor: '#ff8fa3', transitWay: '步行', transitTime: '10' });

                // 2. 智慧邏輯：自動挪移過期行程 (checkIsPast)
                const sortedItems = computed(() => {
                    const now = new Date();
                    const currentItems = itinerary.value[selectedDayIdx.value].items || [];
                    
                    const processed = currentItems.map(item => {
                        const [h, m] = item.time.split(':');
                        const itemTime = new Date(); // 簡化處理，實際應對接行程日期
                        itemTime.setHours(h, m, 0);
                        
                        // 若過去超過 30 分鐘，標記為 isPast
                        const isPast = (now - itemTime) > 30 * 60 * 1000;
                        return { ...item, isPast };
                    });

                    // 排序：未過期在前，過期在後
                    return processed.sort((a, b) => {
                        if (a.isPast === b.isPast) return a.time.localeCompare(b.time);
                        return a.isPast ? 1 : -1;
                    });
                });

                // 3. 智慧整合：API 串接
                const fetchAPIs = async () => {
                    // 天氣 (wttr.in) - 高可信度釜山預測
                    try {
                        const wRes = await fetch('https://wttr.in/Busan?format=j1');
                        const wData = await wRes.json();
                        const curr = wData.current_condition[0];
                        weather.value = { temp: curr.temp_C + '°', desc: curr.weatherDesc[0].value, icon: 'sun' };
                        weatherLoading.value = false;
                    } catch (e) { weather.value = { temp: '16°', desc: 'Sunny', icon: 'sun' }; }

                    // 匯率 (er-api.com)
                    try {
                        const rRes = await fetch('https://open.er-api.com/v6/latest/KRW');
                        const rData = await rRes.json();
                        exchangeRate.value = rData.rates.TWD ? (1 / rData.rates.TWD).toFixed(2) : '---';
                    } catch (e) {}
                    
                    setTimeout(() => lucide.createIcons(), 300);
                };

                onMounted(() => {
                    fetchAPIs();
                    setInterval(() => {
                        const d = new Date();
                        currentTime.value = d.toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit' });
                    }, 1000);
                    lucide.createIcons();
                });

                // 監聽並存檔
                watch([itinerary, travelInfo], () => {
                    localStorage.setItem('busan_v20_itinerary', JSON.stringify(itinerary.value));
                    localStorage.setItem('busan_v20_info', JSON.stringify(travelInfo.value));
                    setTimeout(() => lucide.createIcons(), 100);
                }, { deep: true });

                return {
                    activeTab, selectedDayIdx, itinerary, travelInfo, sortedItems, weather, exchangeRate, currentTime,
                    showModal, form, categories, weatherLoading,
                    openModal: (mode) => { showModal.value = true; },
                    saveItem: () => {
                        itinerary.value[selectedDayIdx.value].items.push({...form.value});
                        showModal.value = false;
                    },
                    openNaver: (loc) => window.open(`https://map.naver.com/v5/search/${encodeURIComponent(loc)}`),
                    getTransitIcon: (way) => ({ '步行': 'move', '地鐵': 'train', '巴士': 'bus', '飛航': 'plane' }[way] || 'car')
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
